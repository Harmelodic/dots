#!/bin/bash

# Clone all repos from a Bitbucket project.

source $DOTS/vars

read -p "Domain? (e.g. bitbucket.example.com): " domain
read -p "Project Code?: " project
read -p "Username?: " username
read -s -p "Password?: " password

authString=`echo -n "$username:$password" | base64`

if [ ! -z "$domain" ] && [ ! -z "$project" ] && [ ! -z "$username" ]; then
    if [ "$1" == "ssh" ]; then
        curl -s --header "Authorization: Basic $authString" "https://$domain/rest/api/1.0/projects/$project/repos?limit=1000" \
            | jq ".values[].links.clone[] | select(.name == \"ssh\") | .href" \
            | xargs -I {} git clone {}
    else
        curl -s --header "Authorization: Basic $authString" "https://$domain/rest/api/1.0/projects/$project/repos?limit=1000" \
            | jq ".values[].links.clone[] | select(.name == \"http\") | .href" \
            | xargs -I {} git clone {}
    fi
else
    echo "Please give a domain, project and username"
fi
